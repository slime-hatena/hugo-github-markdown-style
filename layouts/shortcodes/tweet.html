{{/* See: https://github.com/gohugoio/hugo/blob/master/tpl/tplimpl/embedded/templates/_shortcodes/x.html */}}

{{- $pc := site.Config.Privacy.X -}}
{{- if not $pc.Disable -}}
  {{- if $pc.Simple -}}
    {{- template "_shortcodes/x_simple.html" . -}}
  {{- else -}}
    {{- $id := or (.Get "id") "" -}}
    {{- $user := or (.Get "user") "" -}}
    {{- if and $id $user -}}
      {{- if .Site.Params.alternativeTweet -}}
        {{- template "render-tweet-alternative" (dict "id" $id "user" $user "dnt" $pc.EnableDNT) -}}
      {{- else -}}
        {{- template "render-x" (dict "id" $id "user" $user "dnt" $pc.EnableDNT "ctx" .) -}}
      {{- end -}}
    {{- else -}}
      {{- errorf "The %q shortcode requires two named parameters: user and id. See %s" .Name .Position -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- define "render-x" -}}
  {{- $url := printf "https://x.com/%v/status/%v" .user .id -}}
  {{- $query := querify "url" $url "dnt" .dnt -}}
  {{- $request := printf "https://publish.x.com/oembed?%s" $query -}}
  {{- with try (resources.GetRemote $request) -}}
    {{- with .Err -}}
      {{- warnidf "shortcode-x-getremote" "The %q shortcode was unable to retrieve the remote data: %s. See %s" $.ctx.Name . $.ctx.Position -}}
    {{- else with .Value -}}
      {{- (. | transform.Unmarshal).html | safeHTML -}}
    {{- else -}}
      {{- warnidf "shortcode-x-getremote" "The %q shortcode was unable to retrieve the remote data. See %s" $.ctx.Name $.ctx.Position -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- define "render-tweet-alternative" -}}
<div id="tweet-{{ .id }}">
  <blockquote class="twitter-tweet-prepare">
    <a href="https://twitter.com/{{ .user }}/status/{{ .id }}" target="_blank">Tweet: {{ .id }}</a><br>
    ツイートを読込中です。もし表示されない場合はアカウントが非公開になったか、ツイートが削除されているかもしれません。
  </blockquote>
</div>
<script>((b)=>{b=document.querySelector("#tweet-{{ .id }}>blockquote");b.dataset.theme=((window.matchMedia('(prefers-color-scheme:dark)').matches)?'dark':'light');b.className="twitter-tweet";})()</script>
{{- end -}}
